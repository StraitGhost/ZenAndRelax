<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Editar P谩gina Principal - ZenzAndRelax</title>
  <link rel="icon" href="https://i.imgur.com/7XfLSeT.png" type="image/png">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
  <link rel="stylesheet" href="editar-home.css">
</head>
<body>
  <div class="admin-container">
    <header class="admin-header">
      <div class="header-content">
        <h1><i class="fas fa-home"></i> Panel de Administraci贸n - P谩gina Principal</h1>
        <p>Gestiona el contenido de la p谩gina de inicio</p>
      </div>
      <a href="zenzandrelax.html" class="back-to-site">
        <i class="fas fa-arrow-left"></i> Volver al Inicio
      </a>
    </header>

    <main class="admin-main">
      <!-- Sidebar - SOLO con Tarjetas de Servicios -->
      <aside class="admin-sidebar">
        <div class="sidebar-header">
          <i class="fas fa-cog"></i> Configuraci贸n
        </div>
        <div class="sidebar-nav">
          <button class="nav-item active">
            <i class="fas fa-th-large"></i>
            <span>Tarjetas de Servicios</span>
          </button>
        </div>
      </aside>

      <!-- Main Content - SOLO secci贸n de tarjetas -->
      <div class="admin-content">
        <div class="content-header">
          <h2 id="sectionTitle">Tarjetas de Servicios</h2>
          <div class="content-actions">
            <button class="btn-add-card" id="addCardBtn">
              <i class="fas fa-plus"></i> Agregar Tarjeta
            </button>
          </div>
        </div>

        <!-- Cards Section -->
        <div id="cardsSection" class="admin-section">
          <div class="cards-container" id="cardsContainer">
            <!-- Las tarjetas se cargar谩n din谩micamente aqu铆 -->
          </div>
        </div>

        <div class="empty-state" id="emptyState" style="display: none;">
          <i class="fas fa-th-large"></i>
          <h3>No hay tarjetas configuradas</h3>
          <p>Haz clic en "Agregar Tarjeta" para crear tu primer servicio</p>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal para agregar/editar tarjeta -->
  <div class="modal" id="cardModal">
    <div class="modal-content">
      <button class="close-modal" onclick="closeModal()">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header">
        <h2 id="modalTitle"><i class="fas fa-plus-circle"></i> Agregar Nueva Tarjeta</h2>
      </div>
      <div class="modal-body">
        <form id="cardForm">
          <input type="hidden" id="cardId">
          
          <div class="form-group">
            <label for="cardTitle">
              <i class="fas fa-heading"></i> T铆tulo del Servicio
              <span class="required">*</span>
            </label>
            <input type="text" id="cardTitle" required placeholder="Ej: Masajes Terap茅uticos">
          </div>

          <div class="form-group">
            <label for="cardDescription">
              <i class="fas fa-align-left"></i> Descripci贸n
              <span class="required">*</span>
            </label>
            <textarea id="cardDescription" rows="4" required placeholder="Describe el servicio..."></textarea>
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label for="cardIcon">
                <i class="fas fa-icons"></i> cono (Font Awesome)
              </label>
              <input type="text" id="cardIcon" placeholder="fas fa-spa" value="fas fa-leaf">
              <small class="form-hint">Ej: fas fa-leaf, fas fa-moon, fas fa-heart</small>
            </div>
            <div class="form-group half">
              <label for="cardColor">
                <i class="fas fa-palette"></i> Color Principal
              </label>
              <div class="color-picker">
                <input type="color" id="cardColor" value="#4B0082" onchange="updateColorValue()">
                <span class="color-value" id="colorValue">#4B0082</span>
              </div>
            </div>
          </div>

          <div class="form-group">
            <label for="cardLink">
              <i class="fas fa-link"></i> Enlace (opcional)
            </label>
            <input type="url" id="cardLink" placeholder="https://ejemplo.com/servicio">
          </div>

          <div class="form-group">
            <label for="cardOrder">
              <i class="fas fa-sort"></i> Orden de visualizaci贸n
            </label>
            <input type="number" id="cardOrder" min="0" value="0">
            <small class="form-hint">N煤mero m谩s bajo = aparece primero</small>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal()">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="btn btn-primary" onclick="saveCard()">
          <i class="fas fa-save"></i> Guardar Tarjeta
        </button>
      </div>
    </div>
  </div>

  <!-- Modal de Confirmaci贸n para Eliminar -->
  <div class="modal" id="deleteConfirmModal">
    <div class="modal-content delete-modal">
      <button class="close-modal" onclick="closeModal('deleteConfirmModal')">
        <i class="fas fa-times"></i>
      </button>
      <div class="modal-header delete-header">
        <i class="fas fa-exclamation-triangle warning-icon"></i>
        <h2>驴Eliminar Tarjeta?</h2>
      </div>
      <div class="modal-body delete-body">
        <div class="warning-message">
          <p><strong>锔 Esta acci贸n es irreversible</strong></p>
          <p>Est谩s a punto de eliminar permanentemente la tarjeta <strong id="deleteCardName"></strong>.</p>
        </div>
        <div class="confirmation-prompt">
          <p>Escribe <strong style="color: #DC3545; font-weight: bold;">"ELIMINAR"</strong> para confirmar:</p>
          <input type="text" id="deleteConfirmationInput" placeholder="ELIMINAR" class="delete-input">
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('deleteConfirmModal')">
          <i class="fas fa-times"></i> Cancelar
        </button>
        <button class="btn btn-delete" id="confirmDeleteBtn" onclick="confirmDeleteCard()" disabled>
          <i class="fas fa-trash"></i> Eliminar Permanentemente
        </button>
      </div>
    </div>
  </div>

  <!-- Alertas Mejoradas -->
  <div class="alert-container" id="alertContainer"></div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script>
    // Configuraci贸n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyCitpA4mXPQ967ow0le8Kr9HX26dAnKSM0",
      authDomain: "zenzandrelax.firebaseapp.com",
      projectId: "zenzandrelax",
      storageBucket: "zenzandrelax.firebasestorage.app",
      messagingSenderId: "109863701908",
      appId: "1:109863701908:web:9223d4b23599eca7215381"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Variables globales
    let currentCardId = null;

    // Verificar autenticaci贸n
    auth.onAuthStateChanged((user) => {
      if (!user) {
        window.location.href = 'login.html';
        return;
      }
      checkAdminRole(user);
    });

    function checkAdminRole(user) {
      db.collection('users').where('uid', '==', user.uid).get().then((snapshot) => {
        if (!snapshot.empty) {
          const userData = snapshot.docs[0].data();
          if (userData.role !== 'admin') {
            showAlert('No tienes permisos de administrador para acceder a esta p谩gina', 'error');
            setTimeout(() => {
              window.location.href = 'zenzandrelax.html';
            }, 2000);
          } else {
            loadCards();
          }
        } else {
          window.location.href = 'zenzandrelax.html';
        }
      }).catch((error) => {
        console.error('Error al verificar rol:', error);
        window.location.href = 'zenzandrelax.html';
      });
    }

    // Cargar tarjetas desde Firestore (colecci贸n home_cards)
    function loadCards() {
      db.collection('home_cards').orderBy('order', 'asc').get().then((snapshot) => {
        const container = document.getElementById('cardsContainer');
        const emptyState = document.getElementById('emptyState');
        
        container.innerHTML = '';
        
        if (snapshot.empty) {
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        
        snapshot.forEach((doc) => {
          const card = doc.data();
          createCardElement(card, doc.id);
        });
      }).catch((error) => {
        console.error('Error al cargar tarjetas:', error);
        showAlert('Error al cargar las tarjetas: ' + error.message, 'error');
      });
    }

    // Crear elemento de tarjeta
    function createCardElement(card, cardId) {
      const container = document.getElementById('cardsContainer');
      const cardElement = document.createElement('div');
      cardElement.className = 'card-item';
      cardElement.style.backgroundColor = card.color || '#4B0082';
      
      const displayColor = card.color || '#4B0082';
      
      cardElement.innerHTML = `
        <div class="card-header">
          <div class="card-icon-preview">
            <i class="${card.icon || 'fas fa-leaf'}"></i>
          </div>
          <h3>${card.title || 'Sin t铆tulo'}</h3>
        </div>
        <div class="card-content">
          <p>${card.description || 'Sin descripci贸n'}</p>
          ${card.link ? `<p class="card-link-preview"> <a href="${card.link}" target="_blank">${card.link}</a></p>` : ''}
          <div class="card-meta">
            <span class="card-color-preview" style="background-color: ${displayColor}"></span>
            <span class="card-order">Orden: ${card.order || 0}</span>
          </div>
        </div>
        <div class="card-actions">
          <button class="card-btn btn-edit" onclick="editCard('${cardId}')">
            <i class="fas fa-edit"></i> Editar
          </button>
          <button class="card-btn btn-delete" onclick="showDeleteConfirmation('${cardId}', '${card.title || 'Sin t铆tulo'}')">
            <i class="fas fa-trash"></i> Eliminar
          </button>
        </div>
      `;
      
      container.appendChild(cardElement);
    }

    // Abrir modal para agregar tarjeta
    function openAddCardModal() {
      currentCardId = null;
      document.getElementById('modalTitle').innerHTML = '<i class="fas fa-plus-circle"></i> Agregar Nueva Tarjeta';
      document.getElementById('cardForm').reset();
      document.getElementById('cardColor').value = '#4B0082';
      document.getElementById('colorValue').textContent = '#4B0082';
      document.getElementById('cardOrder').value = '0';
      document.getElementById('cardModal').classList.add('active');
    }

    // Cerrar modal
    function closeModal(modalId = 'cardModal') {
      document.getElementById(modalId).classList.remove('active');
      
      if (modalId === 'cardModal') {
        document.getElementById('cardForm').reset();
        currentCardId = null;
      } else if (modalId === 'deleteConfirmModal') {
        document.getElementById('deleteConfirmationInput').value = '';
        document.getElementById('confirmDeleteBtn').disabled = true;
        document.getElementById('deleteConfirmationInput').classList.remove('valid');
      }
    }

    // Actualizar valor del color
    function updateColorValue() {
      const colorInput = document.getElementById('cardColor');
      document.getElementById('colorValue').textContent = colorInput.value;
    }

    // Editar tarjeta
    function editCard(cardId) {
      db.collection('home_cards').doc(cardId).get().then((doc) => {
        if (doc.exists) {
          const card = doc.data();
          currentCardId = cardId;
          
          document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit"></i> Editar Tarjeta';
          document.getElementById('cardId').value = cardId;
          document.getElementById('cardTitle').value = card.title || '';
          document.getElementById('cardDescription').value = card.description || '';
          document.getElementById('cardIcon').value = card.icon || 'fas fa-leaf';
          document.getElementById('cardLink').value = card.link || '';
          document.getElementById('cardOrder').value = card.order || 0;
          
          // Establecer color
          const colorValue = card.color || '#4B0082';
          document.getElementById('cardColor').value = colorValue;
          document.getElementById('colorValue').textContent = colorValue;
          
          document.getElementById('cardModal').classList.add('active');
        }
      }).catch((error) => {
        console.error('Error al cargar tarjeta:', error);
        showAlert('Error al cargar la tarjeta', 'error');
      });
    }

    // Guardar tarjeta
    async function saveCard() {
      const title = document.getElementById('cardTitle').value.trim();
      const description = document.getElementById('cardDescription').value.trim();
      const icon = document.getElementById('cardIcon').value.trim();
      const link = document.getElementById('cardLink').value.trim();
      const order = parseInt(document.getElementById('cardOrder').value) || 0;
      const color = document.getElementById('cardColor').value;

      if (!title || !description) {
        showAlert('Por favor completa todos los campos obligatorios (t铆tulo y descripci贸n)', 'error');
        return;
      }

      try {
        const cardData = {
          title,
          description,
          icon: icon || 'fas fa-leaf',
          link: link || '',
          order: order,
          color: color || '#4B0082',
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (currentCardId) {
          // Editar tarjeta existente
          await db.collection('home_cards').doc(currentCardId).update(cardData);
          showAlert('Tarjeta actualizada exitosamente', 'success');
        } else {
          // Crear nueva tarjeta
          await db.collection('home_cards').add(cardData);
          showAlert('Tarjeta creada exitosamente', 'success');
        }

        closeModal();
        loadCards();
      } catch (error) {
        console.error('Error al guardar tarjeta:', error);
        showAlert('Error al guardar la tarjeta: ' + error.message, 'error');
      }
    }

    // Mostrar confirmaci贸n de eliminaci贸n
    function showDeleteConfirmation(cardId, cardName) {
      currentCardId = cardId;
      document.getElementById('deleteCardName').textContent = cardName;
      document.getElementById('deleteConfirmationInput').value = '';
      document.getElementById('deleteConfirmModal').classList.add('active');
      
      // Resetear estado del bot贸n
      document.getElementById('confirmDeleteBtn').disabled = true;
      document.getElementById('deleteConfirmationInput').classList.remove('valid');
    }

    // Validar input de confirmaci贸n
    document.getElementById('deleteConfirmationInput').addEventListener('input', function() {
      const value = this.value.trim();
      const btn = document.getElementById('confirmDeleteBtn');
      if (value === 'ELIMINAR') {
        btn.disabled = false;
        this.classList.add('valid');
      } else {
        btn.disabled = true;
        this.classList.remove('valid');
      }
    });

    // Confirmar eliminaci贸n
    function confirmDeleteCard() {
      const confirmation = document.getElementById('deleteConfirmationInput').value.trim();
      
      if (confirmation !== 'ELIMINAR') {
        showAlert('Escribe "ELIMINAR" exactamente para confirmar', 'error');
        return;
      }
      
      if (!currentCardId) {
        showAlert('Error: No hay tarjeta seleccionada', 'error');
        return;
      }
      
      db.collection('home_cards').doc(currentCardId).delete().then(() => {
        closeModal('deleteConfirmModal');
        showAlert('Tarjeta eliminada exitosamente', 'success');
        loadCards();
      }).catch((error) => {
        console.error('Error al eliminar tarjeta:', error);
        showAlert('Error al eliminar la tarjeta: ' + error.message, 'error');
      });
    }

    // Mostrar alerta mejorada
    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      
      // Crear alerta
      const alert = document.createElement('div');
      alert.className = `alert-custom ${type} slide-in`;
      
      // Iconos seg煤n el tipo
      const icons = {
        success: '<i class="fas fa-check-circle"></i>',
        error: '<i class="fas fa-exclamation-circle"></i>',
        warning: '<i class="fas fa-exclamation-triangle"></i>',
        info: '<i class="fas fa-info-circle"></i>'
      };
      
      alert.innerHTML = `
        <div class="alert-icon">${icons[type] || icons.info}</div>
        <div class="alert-content">
          <div class="alert-title">${type === 'success' ? 'xito' : type === 'error' ? 'Error' : type === 'warning' ? 'Advertencia' : 'Informaci贸n'}</div>
          <div class="alert-message">${message}</div>
        </div>
        <button class="alert-close" onclick="this.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      // A帽adir al contenedor
      container.appendChild(alert);
      
      // Remover despu茅s de 5 segundos
      setTimeout(() => {
        alert.classList.add('slide-out');
        setTimeout(() => {
          if (alert.parentNode) {
            alert.parentNode.removeChild(alert);
          }
        }, 300);
      }, 5000);
    }

    // Event listeners
    document.getElementById('addCardBtn').addEventListener('click', openAddCardModal);
    
    // Cerrar modales con clic fuera
    document.querySelectorAll('.modal').forEach(modal => {
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal(modal.id);
        }
      });
    });
    
    // Cerrar modales con tecla Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
          closeModal(modal.id);
        });
      }
    });
  </script>
</body>
</html>